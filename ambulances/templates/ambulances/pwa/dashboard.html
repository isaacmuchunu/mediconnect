<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MediConnect">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>{% if ambulance %}{{ ambulance.call_sign }}{% else %}MediConnect{% endif %} - Ambulance Crew</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/logo-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/logo-16.png">
    <link rel="apple-touch-icon" href="/static/images/logo-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/logo-180.png">
    
    <!-- Tailwind CSS -->
    <link href="/static/dist/output.css" rel="stylesheet">
    
    <!-- Custom PWA Styles -->
    <style>
        /* PWA specific styles */
        .pwa-safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        .status-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .offline-indicator {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
        }
        
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #dc2626;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hide elements during print */
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="h-full bg-gray-50 font-sans antialiased pwa-safe-area">
    <!-- PWA Status Bar -->
    <div id="pwa-status" class="fixed top-0 left-0 right-0 z-50 bg-red-600 text-white text-sm py-1 px-4 text-center transition-transform transform -translate-y-full" style="display: none;">
        <span id="pwa-status-text">Updating...</span>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="fixed top-0 left-0 right-0 z-40 offline-indicator text-white text-sm py-2 px-4 text-center" style="display: none;">
        <i class="fas fa-wifi-slash mr-2"></i>
        You are offline. Some features may be limited.
    </div>
    
    <!-- Main Container -->
    <div class="h-full flex flex-col">
        <!-- Header -->
        <header class="bg-red-600 text-white shadow-lg no-print">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img src="/static/images/logo-32.png" alt="MediConnect" class="w-8 h-8">
                        <div>
                            <h1 class="text-lg font-bold">
                                {% if ambulance %}{{ ambulance.call_sign }}{% else %}MediConnect{% endif %}
                            </h1>
                            {% if crew_member %}
                            <p class="text-red-200 text-sm">{{ crew_member.user.get_full_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <!-- Connection Status -->
                        <div id="connection-status" class="flex items-center">
                            <div class="w-2 h-2 bg-green-400 rounded-full status-indicator"></div>
                            <span class="ml-1 text-xs">Online</span>
                        </div>
                        
                        <!-- Emergency Button -->
                        <button id="emergency-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-full text-sm font-medium transition-colors">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Emergency
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            {% if error %}
            <!-- Error State -->
            <div class="p-4">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>{{ error }}</span>
                    </div>
                </div>
            </div>
            {% else %}
            
            <!-- Current Status -->
            <div class="bg-white shadow-sm border-b">
                <div class="px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Current Status</h2>
                            {% if ambulance %}
                            <p class="text-sm text-gray-600">
                                Status: <span id="current-status" class="font-medium 
                                {% if ambulance.status == 'AVAILABLE' %}text-green-600
                                {% elif ambulance.status == 'EN_ROUTE' %}text-blue-600
                                {% elif ambulance.status == 'ON_SCENE' %}text-yellow-600
                                {% elif ambulance.status == 'TRANSPORTING' %}text-orange-600
                                {% elif ambulance.status == 'AT_HOSPITAL' %}text-purple-600
                                {% else %}text-red-600{% endif %}">
                                    {{ ambulance.get_status_display }}
                                </span>
                            </p>
                            {% endif %}
                        </div>
                        
                        <button id="update-status-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>
                            Update Status
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Current Dispatch -->
            {% if current_dispatch %}
            <div class="bg-white m-4 rounded-lg shadow-sm border">
                <div class="px-4 py-3 border-b">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-ambulance mr-2 text-red-600"></i>
                        Active Dispatch
                    </h3>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <span class="text-sm font-medium text-gray-500">Incident Type:</span>
                            <p class="text-lg">{{ current_dispatch.incident_type }}</p>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">Priority:</span>
                            <p class="text-lg">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if current_dispatch.priority == 'HIGH' %}bg-red-100 text-red-800
                                {% elif current_dispatch.priority == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ current_dispatch.priority }}
                                </span>
                            </p>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">Location:</span>
                            <p class="text-lg">{{ current_dispatch.incident_address }}</p>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">Time:</span>
                            <p class="text-lg">{{ current_dispatch.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                        
                        {% if current_dispatch.estimated_arrival_time %}
                        <div>
                            <span class="text-sm font-medium text-gray-500">ETA:</span>
                            <p class="text-lg">{{ current_dispatch.estimated_arrival_time|date:"H:i" }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-4 grid grid-cols-2 gap-3">
                        <a href="/ambulance/crew/navigation/" class="bg-blue-600 hover:bg-blue-700 text-white text-center px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            Navigate
                        </a>
                        <a href="/ambulance/crew/dispatch/" class="bg-gray-600 hover:bg-gray-700 text-white text-center px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-info-circle mr-1"></i>
                            Details
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- No Active Dispatch -->
            <div class="bg-white m-4 rounded-lg shadow-sm border">
                <div class="p-6 text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-ambulance text-2xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Active Dispatch</h3>
                    <p class="text-gray-600">Waiting for dispatch assignment...</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Actions -->
            <div class="bg-white m-4 rounded-lg shadow-sm border">
                <div class="px-4 py-3 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Quick Actions</h3>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 gap-3">
                        <a href="/ambulance/crew/patient/" class="bg-green-600 hover:bg-green-700 text-white text-center px-4 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-user-injured block text-xl mb-1"></i>
                            Patient Info
                        </a>
                        
                        <a href="/ambulance/crew/communication/" class="bg-purple-600 hover:bg-purple-700 text-white text-center px-4 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-comments block text-xl mb-1"></i>
                            Communication
                        </a>
                        
                        <button id="share-location-btn" class="bg-orange-600 hover:bg-orange-700 text-white text-center px-4 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-map-pin block text-xl mb-1"></i>
                            Share Location
                        </button>
                        
                        <button id="emergency-call-btn" class="bg-red-600 hover:bg-red-700 text-white text-center px-4 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-phone block text-xl mb-1"></i>
                            Emergency Call
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Vehicle Status -->
            {% if ambulance %}
            <div class="bg-white m-4 rounded-lg shadow-sm border">
                <div class="px-4 py-3 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Vehicle Status</h3>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm font-medium text-gray-500">Fuel Level:</span>
                            <div class="mt-1">
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-{% if ambulance.fuel_level > 50 %}green{% elif ambulance.fuel_level > 25 %}yellow{% else %}red{% endif %}-500 h-2 rounded-full" style="width: {{ ambulance.fuel_level }}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">{{ ambulance.fuel_level }}%</span>
                            </div>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">Mileage:</span>
                            <p class="text-lg font-medium">{{ ambulance.mileage|floatformat:0 }} mi</p>
                        </div>
                    </div>
                    
                    {% if ambulance.current_latitude and ambulance.current_longitude %}
                    <div class="mt-4">
                        <span class="text-sm font-medium text-gray-500">Last GPS Update:</span>
                        <p class="text-sm text-gray-600">{{ ambulance.last_updated|timesince }} ago</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% endif %}
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-200 no-print">
            <div class="grid grid-cols-5 h-16">
                <a href="/ambulance/crew/" class="flex flex-col items-center justify-center text-red-600 bg-red-50">
                    <i class="fas fa-home text-lg"></i>
                    <span class="text-xs mt-1">Dashboard</span>
                </a>
                
                <a href="/ambulance/crew/dispatch/" class="flex flex-col items-center justify-center text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <i class="fas fa-clipboard-list text-lg"></i>
                    <span class="text-xs mt-1">Dispatch</span>
                </a>
                
                <a href="/ambulance/crew/navigation/" class="flex flex-col items-center justify-center text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <i class="fas fa-map-marked-alt text-lg"></i>
                    <span class="text-xs mt-1">Navigate</span>
                </a>
                
                <a href="/ambulance/crew/patient/" class="flex flex-col items-center justify-center text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <i class="fas fa-user-md text-lg"></i>
                    <span class="text-xs mt-1">Patient</span>
                </a>
                
                <a href="/ambulance/crew/communication/" class="flex flex-col items-center justify-center text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <i class="fas fa-comments text-lg"></i>
                    <span class="text-xs mt-1">Comm</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Status Update Modal -->
    <div id="status-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="status-modal-backdrop"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Update Status</h3>
            
            <div class="space-y-3">
                <button class="status-option w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50" data-status="AVAILABLE">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                        <span class="font-medium">Available</span>
                    </div>
                </button>
                
                <button class="status-option w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50" data-status="EN_ROUTE">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                        <span class="font-medium">En Route</span>
                    </div>
                </button>
                
                <button class="status-option w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50" data-status="ON_SCENE">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                        <span class="font-medium">On Scene</span>
                    </div>
                </button>
                
                <button class="status-option w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50" data-status="TRANSPORTING">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-orange-500 rounded-full mr-3"></div>
                        <span class="font-medium">Transporting</span>
                    </div>
                </button>
                
                <button class="status-option w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50" data-status="AT_HOSPITAL">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-purple-500 rounded-full mr-3"></div>
                        <span class="font-medium">At Hospital</span>
                    </div>
                </button>
                
                <button class="status-option w-full text-left px-4 py-3 rounded-lg border hover:bg-gray-50" data-status="OUT_OF_SERVICE">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-red-500 rounded-full mr-3"></div>
                        <span class="font-medium">Out of Service</span>
                    </div>
                </button>
            </div>
            
            <button id="cancel-status-btn" class="w-full mt-4 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span>Loading...</span>
        </div>
    </div>
    
    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    
    <!-- PWA Configuration -->
    <script>
        window.pwaConfig = {{ pwa_config|safe }};
        window.ambulanceStatus = {{ ambulance_status|safe }};
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/js/service-worker.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        function showUpdateNotification() {
            const statusBar = document.getElementById('pwa-status');
            const statusText = document.getElementById('pwa-status-text');
            
            statusText.textContent = 'New version available. Tap to update.';
            statusBar.style.display = 'block';
            statusBar.style.transform = 'translateY(0)';
            statusBar.style.backgroundColor = '#059669';
            
            statusBar.addEventListener('click', function() {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                }
            });
        }
    </script>
    
    <!-- Main PWA JavaScript -->
    <script src="/static/js/ambulance-crew-pwa.js"></script>
</body>
</html>